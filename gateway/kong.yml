_format_version: "3.0"
_transform: true

services:
  - name: auth-service
    url: http://auth-service:8001
    routes:
      - name: auth-route
        paths: ["/auth"]
        strip_path: true
        # Public route - no auth required

  - name: device-service
    url: http://device-service:8003
    routes:
      - name: device-route
        paths: ["/devices"]
        strip_path: false
        plugins: ${{ env.AUTH_REQUIRED == "1" ? [{"name": "jwt"}] : [] }}

  - name: command-service
    url: http://command-service:8004
    routes:
      - name: command-route
        paths: ["/commands"]
        strip_path: false
        plugins: ${{ env.AUTH_REQUIRED == "1" ? [{"name": "jwt"}] : [] }}

  - name: ingest-service
    url: http://data-ingest-service:8005
    routes:
      - name: ingest-http
        paths: ["/ingest"]
        strip_path: false
        plugins: ${{ env.AUTH_REQUIRED == "1" ? [{"name": "jwt"}] : [] }}

  - name: analytics-service
    url: http://analytics-service:8006
    routes:
      - name: analytics-route
        paths: ["/analytics"]
        strip_path: true
        plugins: ${{ env.AUTH_REQUIRED == "1" ? [{"name": "jwt"}] : [] }}

  - name: notification-service
    url: http://notification-service:8007
    routes:
      - name: notif-route
        paths: ["/notify"]
        strip_path: true
        plugins: ${{ env.AUTH_REQUIRED == "1" ? [{"name": "jwt"}] : [] }}

plugins:
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Authorization
        - Content-Type
        - Origin
      exposed_headers:
        - Link
      credentials: false
      max_age: 3600
  - name: rate-limiting
    config:
      minute: 120
      policy: local
  - name: jwt
    enabled: true  # Controlled per-route via env.AUTH_REQUIRED
    config:
      claims_to_verify: [exp]
      key_claim_name: iss  # Match Keycloak's default claim for issuer
      run_on_preflight: true  # Required for CORS preflight
      secret_is_base64: false
      key_claim_name: iss  # Use issuer as key claim for JWT verification
      # Keycloak JWKS endpoint will be provided via environment variable
      key: ${{ env.KEYCLOAK_JWKS_URI }}
      # Cache JWKS keys for 1 hour (in seconds)
      cache_ttl: 3600
