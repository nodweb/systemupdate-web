groups:
  - name: systemupdate-recording-slo
    interval: 30s
    rules:
      # Error rate per service (5m)
      - record: service:error_rate:ratio_rate5m
        expr: |
          (
            sum by(service_name)(rate(traces_spanmetrics_calls_total{status_code!="STATUS_CODE_OK"}[5m]))
            /
            clamp_min(sum by(service_name)(rate(traces_spanmetrics_calls_total[5m])), 1e-9)
          )

      # Availability per service (5m)
      - record: service:availability:percent5m
        expr: |
          100 * (1 - service:error_rate:ratio_rate5m)

      # p95 latency per service (ms)
      - record: service:latency_p95_ms:5m
        expr: |
          histogram_quantile(0.95, sum by (le, service_name) (rate(traces_spanmetrics_duration_milliseconds_bucket[5m])))

      # Route-level error rate (5m)
      - record: route:error_rate:ratio_rate5m
        expr: |
          (
            sum by(service_name, http_route)(rate(traces_spanmetrics_calls_total{status_code!="STATUS_CODE_OK"}[5m]))
            /
            clamp_min(sum by(service_name, http_route)(rate(traces_spanmetrics_calls_total[5m])), 1e-9)
          )

      # Route-level availability (5m)
      - record: route:availability:percent5m
        expr: |
          100 * (1 - route:error_rate:ratio_rate5m)

      # Route-level p95 latency (ms)
      - record: route:latency_p95_ms:5m
        expr: |
          histogram_quantile(0.95, sum by (le, service_name, http_route) (rate(traces_spanmetrics_duration_milliseconds_bucket[5m])))
